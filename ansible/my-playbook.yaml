---
# ==========================================
# Wait for SSH connection
# ==========================================
- name: Wait for SSH connection
  hosts: all
  become: yes
  gather_facts: false
  vars:
    ansible_python_interpreter: /usr/bin/python3   # FIXED
  tasks:
    - name: Wait for SSH port to be open
      wait_for:
        port: 22
        host: "{{ ansible_host | default(inventory_hostname) }}"
        delay: 10
        timeout: 300


# ==========================================
# Install Docker and dependencies
# ==========================================
- name: Install Docker and dependencies
  hosts: all
  become: yes
  gather_facts: yes
  vars:
    ansible_python_interpreter: /usr/bin/python3   # FIXED
  tasks:

    - name: Wait for cloud-init to finish
      shell: cloud-init status --wait
      changed_when: false

    - name: Wait for yum/dnf lock to be released
      shell: |
        while sudo lsof /var/lib/rpm/* >/dev/null 2>&1 \
          || sudo lsof /var/run/yum.pid >/dev/null 2>&1 \
          || sudo lsof /var/run/dnf.pid >/dev/null 2>&1; do
          echo "Yum/DNF is locked... waiting"
          sleep 10
        done
      changed_when: false

    - name: Small pause for system stabilization
      pause:
        seconds: 20

    - name: Install required packages
      yum:
        name:
          - docker
          - curl
          - python3-pip
        state: present
        update_cache: yes

    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Add ec2-user to docker group
      user:
        name: ec2-user
        groups: docker
        append: yes

    - name: Try downloading Docker Compose binary (retry)
      shell: |
        for i in 1 2 3 4 5; do
          curl -fsSL \
            -o /usr/local/bin/docker-compose \
            https://github.com/docker/compose/releases/download/1.29.1/docker-compose-Linux-{{ ansible_architecture }} && break
          echo "Retrying..."
          sleep $((i * 5))
        done
      args:
        executable: /bin/bash
      register: compose_download
      ignore_errors: true

    - name: Ensure docker-compose binary is executable
      file:
        path: /usr/local/bin/docker-compose
        mode: '0755'
      when: compose_download.rc == 0

    - name: Install python docker-compose library for Ansible
      pip:
        name: docker-compose
        executable: /usr/bin/pip3

    - name: Install Docker Python SDK
      pip:
        name: docker
        executable: /usr/bin/pip3

    - name: Install Python requests library
      pip:
        name: requests
        executable: /usr/bin/pip3


# ==========================================
# Copy docker-compose file
# ==========================================
- name: Copy docker-compose.yaml to EC2
  hosts: all
  become: yes
  gather_facts: yes
  vars:
    ansible_python_interpreter: /usr/bin/python3   # FIXED
  vars_files:
    - project-vars
  tasks:
    - name: Copy docker-compose.yaml
      copy:
        src: /mnt/c/Users/Anil.Kumar.XOR-IND/techworld-with-nana-java-maven-app/docker-compose.yml
        dest: /home/ec2-user/docker-compose.yml
        owner: ec2-user
        group: ec2-user
        mode: '0644'


# # ==========================================
# # Docker login and deploy
# # ==========================================
# - name: Docker login & deploy stack
#   hosts: "{{vm_path}}"
#   become: yes
#   gather_facts: yes
#   vars:
#     ansible_python_interpreter: /usr/bin/python3   # FIXED
#   vars_files:
#     - project-vars
#   tasks:

#     - name: Docker login
#       docker_login:
#         registry_url: https://index.docker.io/v1/
#         username: anil2469
#         password: "{{ docker_password }}"
#       environment:
#         DOCKER_HOST: unix:///var/run/docker.sock

#     - name: Start Docker Compose stack
#       docker_compose:
#         project_src: /home/ec2-user
#         state: present
#       environment:
#         DOCKER_HOST: unix:///var/run/docker.sock
