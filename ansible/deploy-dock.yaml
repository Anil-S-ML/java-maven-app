# ==========================================
# Wait for SSH connection
# ==========================================
- name: Wait for SSH connection
  hosts: aws_ec2
  become: yes
  gather_facts: false
  vars:
    ansible_python_interpreter: /usr/bin/python3
  tasks:
    - name: Wait for SSH port to be open
      wait_for:
        port: 22
        host: "{{ ansible_host | default(inventory_hostname) }}"
        delay: 10
        timeout: 300


# ==========================================
# Install Docker and dependencies
# ==========================================
- name: Install Docker and dependencies
  hosts: aws_ec2
  become: yes
  gather_facts: yes
  vars:
    ansible_python_interpreter: /usr/bin/python3
  tasks:

    - name: Remove curl-minimal to avoid conflicts
      yum:
        name: curl-minimal
        state: absent
      ignore_errors: yes

    - name: Clean yum metadata cache
      command: yum clean all

    - name: Install required packages
      yum:
        name:
          - docker
          - curl
          - python3
          - python3-pip
        state: present
        update_cache: yes

    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Add ec2-user to docker group
      user:
        name: ec2-user
        groups: docker
        append: yes

    - name: Reload SSHD so docker group applies
      service:
        name: sshd
        state: reloaded


    # ----------------------------------------------------------
    # Create Python Virtual Environment for Docker SDK
    # ----------------------------------------------------------
    - name: Install virtualenv via pip
      pip:
        name: virtualenv
        executable: pip3

    - name: Create Python virtual environment
      command: python3 -m venv /opt/docker_venv
      args:
        creates: /opt/docker_venv

    - name: Install Docker SDK into virtual environment
      command: /opt/docker_venv/bin/pip install docker requests


    # ----------------------------------------------------------
    # Install Docker Compose V2 (official plugin)
    # ----------------------------------------------------------
    - name: Install Docker Compose V2 plugin
      shell: |
        mkdir -p /usr/libexec/docker/cli-plugins
        curl -SL https://github.com/docker/compose/releases/download/v2.29.2/docker-compose-linux-{{ ansible_architecture }} \
          -o /usr/libexec/docker/cli-plugins/docker-compose
      args:
        executable: /bin/bash

    - name: Set execute permission for compose plugin
      file:
        path: /usr/libexec/docker/cli-plugins/docker-compose
        mode: '0755'


    # ----------------------------------------------------------
    # Add docker-compose v1 compatibility (so "docker-compose" works)
    # ----------------------------------------------------------
    - name: Remove old docker-compose binary if exists
      file:
        path: /usr/local/bin/docker-compose
        state: absent
      ignore_errors: yes

    - name: Create docker-compose v1 compatibility symlink
      file:
        src: /usr/libexec/docker/cli-plugins/docker-compose
        dest: /usr/local/bin/docker-compose
        state: link
        mode: '0755'


# ==========================================
# Copy docker-compose.yaml
# ==========================================
- name: Copy docker-compose.yaml to EC2
  hosts: aws_ec2
  become: yes
  gather_facts: yes
  vars:
    ansible_python_interpreter: /usr/bin/python3
  vars_files:
    - project-vars
  tasks:
    - name: Copy docker-compose.yaml
      copy:
        src: /mnt/c/Users/Anil.Kumar.XOR-IND/techworld-with-nana-java-maven-app/docker-compose.yml
        dest: /home/ec2-user/docker-compose.yml
        owner: ec2-user
        group: ec2-user
        mode: '0644'


# ==========================================
# Docker login & deploy
# ==========================================
- name: Docker login & deploy stack
  hosts: aws_ec2
  become: yes
  gather_facts: yes
  vars:
    ansible_python_interpreter: /usr/bin/python3
  vars_files:
    - project-vars
  tasks:

    # REQUIRED FIX â€” requests must be installed system-wide
    - name: Install system-level Python requests (required for docker_login)
      pip:
        name: requests
        executable: pip3

    - name: Docker login
      docker_login:
        registry_url: https://index.docker.io/v1/
        username: anil2469
        password: "{{ docker_password }}"
      environment:
        DOCKER_HOST: unix:///var/run/docker.sock

    - name: Deploy stack using docker compose (v2)
      shell: |
        docker compose -f /home/ec2-user/docker-compose.yml up -d
      args:
        executable: /bin/bash
      environment:
        DOCKER_HOST: unix:///var/run/docker.sock
